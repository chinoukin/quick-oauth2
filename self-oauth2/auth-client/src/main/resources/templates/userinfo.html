<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户信息</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 30px;
        }
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .nav-links a {
            margin-left: 20px;
            padding: 8px 16px;
            background-color: #f8f9fa;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .nav-links a:hover {
            background-color: #e9ecef;
        }
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .user-profile, .api-result {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .user-profile h3, .api-result h3 {
            color: #333;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }
        .profile-section {
            margin: 20px 0;
        }
        .profile-item {
            display: flex;
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        .profile-label {
            min-width: 120px;
            font-weight: bold;
            color: #555;
        }
        .profile-value {
            color: #333;
            word-break: break-all;
        }
        .avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            margin: 0 auto 20px;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            background-color: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
        }
        .result-box {
            background-color: #f1f1f1;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
        }
        .api-info {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #007bff;
        }
        .actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 12px;
            margin: 2px;
        }
        .badge-primary {
            background-color: #007bff;
            color: white;
        }
        .badge-success {
            background-color: #28a745;
            color: white;
        }
        .badge-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .token-display {
            font-family: monospace;
            font-size: 11px;
            background-color: #2b2b2b;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        .debug-info {
            font-size: 12px;
            color: #666;
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px dashed #ddd;
            grid-column: 1 / -1;
        }
        .json-key { color: #f92672; }
        .json-string { color: #a6e22e; }
        .json-number { color: #ae81ff; }
        .json-boolean { color: #fd971f; }
        .json-null { color: #f8f8f2; }
    </style>
</head>
<body>
<div class="container">
    <div class="nav-bar">
        <h1>用户信息</h1>
        <div class="nav-links">
            <a href="/home">首页</a>
            <a href="/products">产品列表</a>
            <a href="/admin">管理面板</a>
            <a href="/logout">退出</a>
        </div>
    </div>

    <div class="api-info">
        <p><strong>API端点:</strong> http://localhost:8081/api/user/info</p>
        <p><strong>请求方法:</strong> GET</p>
        <p><strong>所需权限:</strong> 需要认证用户</p>
    </div>

    <div class="content">
        <div class="user-profile">
            <h3>用户资料</h3>
            <div class="avatar">
                <span th:text="${#strings.substring(username, 0, 1).toUpperCase()}">U</span>
            </div>

            <div class="profile-section">
                <h4>基本信息</h4>
                <div class="profile-item">
                    <div class="profile-label">用户名:</div>
                    <div class="profile-value" th:text="${username}">未登录</div>
                </div>

                <div class="profile-item" th:if="${attributes}">
                    <div class="profile-label">用户ID:</div>
                    <div class="profile-value" th:text="${attributes.sub} ?: 'N/A'"></div>
                </div>

                <div class="profile-item" th:if="${attributes}">
                    <div class="profile-label">邮箱:</div>
                    <div class="profile-value" th:text="${attributes.email} ?: '未设置'"></div>
                </div>

                <div class="profile-item" th:if="${attributes}">
                    <div class="profile-label">创建时间:</div>
                    <div class="profile-value">
                        <span th:text="${#dates.format(#dates.createNow(), 'yyyy-MM-dd HH:mm:ss')}"></span>
                    </div>
                </div>
            </div>

            <div class="profile-section" th:if="${attributes}">
                <h4>权限信息</h4>
                <div class="profile-item">
                    <div class="profile-label">角色:</div>
                    <div class="profile-value">
                            <span th:if="${attributes.authorities}">
                                <span th:each="auth : ${attributes.authorities}" class="badge badge-primary">
                                    <span th:text="${auth}"></span>
                                </span>
                            </span>
                        <span th:unless="${attributes.authorities}">
                                <span class="badge badge-warning">无特殊权限</span>
                            </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="api-result">
            <h3>API调用结果</h3>
            <div th:if="${status == 'success'}" class="success">
                ✅ API调用成功！
            </div>
            <div th:if="${error}" class="error">
                ❌ <span th:text="${error}"></span>
            </div>

            <div class="result-box">
                <pre id="json-display" th:text="${userInfo} ?: '等待API响应...'"></pre>
            </div>

            <div class="actions">
                <a th:href="@{/userinfo}" class="btn">刷新数据</a>
                <a th:href="@{/home}" class="btn">返回首页</a>
                <a th:href="@{/products}" class="btn btn-success">查看产品</a>
            </div>
        </div>
    </div>

    <div class="debug-info">
        <h4>调试信息</h4>
        <p><strong>技术详情:</strong></p>
        <ul>
            <li>当前时间: <span th:text="${#dates.createNow()}"></span></li>
            <li>资源服务器: http://localhost:8081</li>
            <li>此页面演示了如何获取用户信息和调用受保护API</li>
            <li>用户信息来自OAuth2授权服务器的用户信息端点</li>
            <li>如果API调用失败，请检查资源服务器是否正常运行</li>
        </ul>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // JSON语法高亮函数
    function syntaxHighlight(json) {
        if (typeof json != 'string') {
            json = JSON.stringify(json, undefined, 2);
        }
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
            function (match) {
                var cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
    }

    // 尝试解析并高亮JSON
    document.addEventListener('DOMContentLoaded', function() {
        var jsonElement = document.getElementById('json-display');
        if (jsonElement) {
            try {
                var jsonText = jsonElement.textContent;
                if (jsonText && jsonText.trim() && jsonText !== '等待API响应...') {
                    var jsonObj = JSON.parse(jsonText);
                    jsonElement.innerHTML = syntaxHighlight(jsonObj);
                }
            } catch (e) {
                // 如果不是JSON，保持原样
            }
        }
    });
    /*]]>*/
</script>
</body>
</html>